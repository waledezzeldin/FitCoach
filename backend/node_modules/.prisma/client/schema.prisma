// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  coach
  admin
  pending_coach
}

enum SubscriptionTier {
  freemium
  premium
  smart_premium
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String?
  name                String?
  phone               String?              @unique
  preferredLocale     String?
  deviceToken         String?
  role                UserRole
  coach               Coach?               @relation("UserCoach") // One-to-one with Coach
  coachId             String? // Foreign key for Coach
  notifications       Notification[] // One-to-many with Notification
  milestones          Milestone[] // One-to-many with Milestone
  payments            Payment[] // One-to-many with Payment
  recommendations     Recommendation[] // One-to-many with Recommendation
  commissions         Commission[] // One-to-many with Commission
  coachClients        Coach?               @relation("CoachClients", fields: [coachClientsId], references: [id])
  coachClientsId      String? // Foreign key for CoachClients relation
  Session             Session[]
  Order               Order[]
  WorkoutLog          WorkoutLog[]
  NutritionLog        NutritionLog[]
  SupplementLog       SupplementLog[]
  Subscription        Subscription[]
  coachRequests       CoachRequest[] // <-- Add this line
  intake              UserIntake?
  subscriptionQuota   SubscriptionQuota?
  nutritionPreference NutritionPreference?
  nutritionAccess     NutritionAccess?
  coachMessages       CoachMessage[]
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  coachId      String?
  coach        Coach?   @relation("CoachSessions", fields: [coachId], references: [id])
  scheduledAt  DateTime
  durationMin  Int      @default(30)
  status       String   @default("scheduled")
  agoraChannel String?
  rating       Int?
  ratingNote   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Order {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  totalCents  Int          @default(0)
  currency    String       @default("usd")
  status      String       @default("pending")
  items       OrderItem[]
  commissions Commission[] // One-to-many with Commission
  payments    Payment[] // One-to-many with Payment
  Delivery    Delivery?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model OrderItem {
  id         String @id @default(uuid())
  orderId    String
  order      Order  @relation(fields: [orderId], references: [id])
  sku        String
  qty        Int
  priceCents Int
}

model Coach {
  id              String             @id @default(uuid())
  userId          String             @unique
  user            User               @relation("UserCoach", fields: [userId], references: [id])
  clients         User[]             @relation("CoachClients")
  commissions     Commission[] // One-to-many with Commission
  recommendations Recommendation[] // One-to-many with Recommendation
  sessions        Session[]          @relation("CoachSessions")
  bio             String?
  certifications  String?
  referralCode    String?
  messages        CoachMessage[]
  specializations String[]           @default([])
  experienceYears Int?
  headline        String?
  verified        Boolean            @default(false)
  certificates    CoachCertificate[]
  experiences     CoachExperience[]
  achievements    CoachAchievement[]
}

model CoachCertificate {
  id                  String    @id @default(uuid())
  coachId             String
  coach               Coach     @relation(fields: [coachId], references: [id])
  name                String
  issuingOrganization String
  issuedAt            DateTime
  expiresAt           DateTime?
  certificateUrl      String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model CoachExperience {
  id           String    @id @default(uuid())
  coachId      String
  coach        Coach     @relation(fields: [coachId], references: [id])
  title        String
  organization String
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  description  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model CoachAchievement {
  id          String   @id @default(uuid())
  coachId     String
  coach       Coach    @relation(fields: [coachId], references: [id])
  title       String
  description String?
  achievedAt  DateTime
  type        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkoutLog {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id])
  date     DateTime
  activity String
  duration Int // minutes
  notes    String?
}

model NutritionLog {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id])
  date     DateTime
  meal     String
  calories Int
  protein  Float?
  carbs    Float?
  fats     Float?
  mealType String?
  notes    String?
}

model SupplementLog {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  date           DateTime
  supplementName String
  dose           String
  notes          String?
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id])
  stripeSubscriptionId String?   @unique
  status               String    @default("inactive")
  planCode             String?
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  payments             Payment[] // One-to-many with Payment
}

model Recommendation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  coachId   String?
  coach     Coach?   @relation(fields: [coachId], references: [id])
  type      String
  content   String
  createdAt DateTime @default(now())
}

model Category {
  id       String    @id @default(uuid())
  name     String
  products Product[]
}

model Bundle {
  id       String    @id @default(uuid())
  name     String
  products Product[] @relation("BundleProducts")
  price    Float
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?
  price       Float?
  priceCents  Int
  currency    String   @default("usd")
  inventory   Int      @default(0)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  bundles     Bundle[] @relation("BundleProducts")
}

model Delivery {
  id            String    @id @default(cuid())
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id])
  status        String // e.g., "pending", "shipped", "delivered"
  trackingUrl   String?
  address       String
  courier       String?
  estimatedDate DateTime?
  updatedAt     DateTime  @updatedAt
  createdAt     DateTime  @default(now())
}

model Affiliate {
  id           String       @id @default(uuid())
  name         String
  referralCode String
  brandUrl     String?
  commissions  Commission[] // One-to-many with Commission
}

model CoachMessage {
  id             String   @id @default(uuid())
  coachId        String
  coach          Coach    @relation(fields: [coachId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  sender         String
  body           String?
  attachmentUrl  String?
  attachmentName String?
  attachmentType String?
  attachmentSize Int?
  createdAt      DateTime @default(now())
}

model Commission {
  id          String     @id @default(uuid())
  coachId     String
  coach       Coach      @relation(fields: [coachId], references: [id])
  orderId     String
  order       Order      @relation(fields: [orderId], references: [id])
  affiliateId String?
  affiliate   Affiliate? @relation(fields: [affiliateId], references: [id])
  amount      Float
  createdAt   DateTime   @default(now())
  User        User?      @relation(fields: [userId], references: [id])
  userId      String?
}

model Analytics {
  id              String   @id @default(cuid())
  date            DateTime @default(now())
  revenue         Float    @default(0)
  engagement      Int      @default(0) // e.g., active users
  supplementSales Int      @default(0)
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Milestone {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  type        String
  description String?
  achievedAt  DateTime?
}

model Payment {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  orderId        String?
  order          Order?        @relation(fields: [orderId], references: [id])
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  amount         Float?
  amountCents    Int           @default(0)
  currency       String
  status         String
  provider       String
  providerId     String?       @unique
  raw            Json?
  createdAt      DateTime      @default(now())
}

model WebhookEvent {
  id        String   @id @default(uuid())
  provider  String
  eventId   String   @unique
  payload   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
}

model CoachRequest {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    String // "pending", "approved", "rejected"
  createdAt DateTime @default(now())
}

model UserIntake {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])
  gender            String?
  mainGoal          String?
  workoutLocation   String?
  firstCompletedAt  DateTime?
  age               Int?
  weightKg          Float?
  heightCm          Float?
  experienceLevel   String?
  workoutFrequency  Int?
  injuries          String[]  @default([])
  secondCompletedAt DateTime?
  skippedSecond     Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model SubscriptionQuota {
  id                  String           @id @default(uuid())
  userId              String           @unique
  user                User             @relation(fields: [userId], references: [id])
  tier                SubscriptionTier @default(freemium)
  messagesUsed        Int              @default(0)
  callsUsed           Int              @default(0)
  attachmentsUsed     Int              @default(0)
  resetAt             DateTime         @default(now())
  nutritionWindowDays Int?
  nutritionExpiresAt  DateTime?
  nutritionLocked     Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
}

model NutritionPreference {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])
  proteinSources    String[]
  proteinAllergies  String[]
  dinnerPreferences Json?
  additionalNotes   String?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model NutritionAccess {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  planGeneratedAt DateTime
  expiresAt       DateTime?
  locked          Boolean   @default(false)
  windowDays      Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
